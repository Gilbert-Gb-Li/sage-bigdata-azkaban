{"id":"58e67610-1843-4d9e-bc8c-621cce2f1142","name":"食药监-饿了么ES宽表","sample":"","parser":{"filter":[{"field":"license_num","cases":[{"value":"[\\s\\S]+","rule":{"id":"ac88cf93-462e-42ed-a67b-a30faf702db7","isScript":false,"name":"byKnowledge"},"name":"case"}],"default":{"id":"ac88cf93-462e-42ed-a67b-a30faf702db7","column":"licno","value":"ocr_license_num","isScript":false,"name":"byKnowledge"},"name":"match"},{"fields":{"license_num_licno":"licno","license_num_entname":"entname","license_num_regaddrdl":"regaddrdl","ocr_license_num_managerange":"managerange","license_num_managerange":"managerange","ocr_license_num_fzr":"fzr","license_num_regaddrzl":"regaddrzl","ocr_license_num_id":"id","license_num_licexpiry":"licexpiry","ocr_license_num_licno":"licno","license_num_addr":"addr","ocr_license_num_localadm":"localadm","ocr_license_num_addr":"addr","ocr_license_credlevel":"credlevel","license_num_localadm":"localadm","license_num_credlevel":"credlevel","ocr_license_num_entname":"entname","ocr_license_num_regaddrzl":"regaddrzl","license_num_shxydm":"shxydm","ocr_license_num_regaddrdl":"regaddrdl","license_num_fzr":"fzr","ocr_license_num_shxydm":"shxydm","ocr_license_num_licexpiry":"licexpiry"},"name":"mapping"},{"script":"var license_num = event.get(\"license_num\");\nvar licno = event.get(\"licno\");\nvar license_num_localadm = event.get(\"license_num_localadm\");\nvar localadm = event.get(\"localadm\");\nvar org_code = event.get(\"org_code\");\n\n//license_num == licno &&\nif( localadm !== null && localadm.toString().length > 0){\nif(license_num_localadm != null && license_num_localadm.toString().length > 0){\n    event.put(\"org_code\",license_num_localadm)\n}else{\n    event.put(\"org_code\",localadm)\n}\n}","type":"js","name":"script"},{"id":"05741826-f8b0-4809-bfe5-3ec78eed8ce1","column":"orgcode","value":"org_code","isScript":false,"name":"byKnowledge"},{"fields":["localadm_orgcode","org_code_id","localadm_id","c@collector","c@path","id","pid","grade","license_num_id","template_version"],"name":"removeFields"},{"fields":{"org_code_fzr":"fzr","org_code_regaddrdl":"regaddrdl","org_code_orgcode":"orgcode","org_code_addr":"addr","org_code_licno":"licno","org_code_localadm":"org_code_localadm","org_code_licexpiry":"licexpiry","org_code_credlevel":"credlevel","orgname":"org_name","org_code_managerange":"managerange","org_code_regaddrzl":"regaddrzl","org_code_entname":"entname","org_code_shxydm":"shxydm"},"name":"mapping"},{"script":"var license_num = event.get(\"license_num\");  //资质信息许可证号\nvar licno = event.get(\"licno\"); //药监库许可证号\nvar licexpiry = event.get(\"licexpiry\");  //许可证过期时间\nvar ocr_issue_date = event.get(\"ocr_issue_date\"); //许可证颁发时间ocr识别\nvar has_license = event.get(\"has_license\");  //是否上传许可证\nvar is_license_vague = event.get(\"is_license_vague\");  //许可证号是否模糊\nvar ocr_business_scope = event.get(\"ocr_business_scope\");  //主营业态是否有网络\nvar has_business_license = event.get(\"has_business_license\");  //是否上传营业执照\nvar ocr_license_num = event.get(\"ocr_license_num\");  //图片识别许可证号\nvar org_code = event.get(\"org_code\");   //替换过的org_code \nvar key_word_hair_num = event.get(\"key_word_hair_num\");  //关键词头发评论数量\nvar key_word_fly_num = event.get(\"key_word_fly_num\");  //关键词苍蝇评论数量\nvar key_word_nfresh_num = event.get(\"key_word_nfresh_num\");  //关键词不心想评论数量\nvar bad_comment_total_num = event.get(\"bad_comment_total_num\");  //差评总数\nvar comment_total_num = event.get(\"comment_total_num\");  //评论总数\nvar expire_time = event.get(\"expire_time\");  //资质信息过期时间\nvar has_ocr_message = event.get(\"has_ocr_message\");  //是否上传ocr信息\nvar shop_cert_photo1 = event.get(\"shop_cert_photo1\");  //资质信息picture1\nvar shop_cert_photo2 = event.get(\"shop_cert_photo2\");  //资质信息picture2\nvar str = \"2018-01-01\";\nvar timestamp = new Date().getTime().toString();\nvar curdate = new Date();\nif(licexpiry !== null && licexpiry.toString().length > 0){\nvar licexpirydate = new Date(licexpiry);\n}\nif(ocr_issue_date !== null && ocr_issue_date.length > 0){\nvar issue_date = new Date(ocr_issue_date)\n}\nvar issue_time = new Date(str)\n\n//创建一证多用所需license_num字段\nif(ocr_license_num !== null){\n    event.put(\"tmp_license_num\",ocr_license_num)\n}\nif(license_num !== null && ocr_license_num == null){\nevent.put(\"tmp_license_num\",license_num)\n}\n\n//101,证过期;102,无网络经营资格;111,证号有误;112,未亮证;113,未亮照;114,JY模糊;115,证件模糊;100,正常\n\nif(expire_time == \"我平台已经对入网餐饮服务提供者的\"){\n\tevent.put(\"expire_time\",null)\n}\nif(has_ocr_message == null){\n\tevent.put(\"has_ocr_message\",0)\n}\nif(org_code){\nvar org_code_2 = org_code.substr(0,2);\nvar org_code_4 = org_code.substr(0,4);\nvar org_code_6 = org_code.substr(0,6);\nevent.put(\"org_code_2\",org_code_2)\nevent.put(\"org_code_4\",org_code_4)\nevent.put(\"org_code_6\",org_code_6)\n}\nif(key_word_hair_num == null){\n\tkey_word_hair_num = 0;\n\tevent.put(\"key_word_hair_num\",0);\n}\nif(key_word_fly_num == null){\n\tkey_word_fly_num = 0;\n\tevent.put(\"key_word_fly_num\",0);\n}\nif(key_word_nfresh_num == null){\n\tkey_word_nfresh_num = 0;\n\tevent.put(\"key_word_nfresh_num\",0);\n}\nvar key_word_total = Number(key_word_hair_num) + Number(key_word_fly_num) + Number(key_word_nfresh_num);\nevent.put(\"key_word_total\",key_word_total);\n\nif(comment_total_num != 0 && comment_total_num !== null ){\nvar bad_comment_rate = Number(bad_comment_total_num) / Number(comment_total_num);\n//event.put(\"bad_comment_rate\",Math.ceil(bad_comment_rate*100)/100);\nevent.put(\"bad_comment_rate\",bad_comment_rate);\n}else{\nevent.put(\"bad_comment_rate\",0);\n}\n\nif(has_license !==null && has_license.length > 0 || has_business_license !==null && has_business_license.length > 0){   //判断ocr信息是否上报\n\tevent.put(\"has_ocr_message\",1)\n}else{\n\tevent.put(\"has_ocr_message\",0)\n}\n// if(shop_cert_photo1 == null && shop_cert_photo2 == null){\n//     //未亮证\n// \tevent.put(\"question_type\",112)\n// }else{\nif(license_num !== null){ //公示信息有jy号\n //------ func1\n\tfunc1();\n //------\n}else{ //公示信息无jy号\n\tif(has_license !==null && has_license.length > 0 || has_business_license !==null && has_business_license.length > 0){\n\tif(has_license != 1){ //未上传许可证\n\t\t//未亮证\n\t\tevent.put(\"question_type\",112)\n\t}else if(has_license == 1){\n\t\tif(is_license_vague == 1){ //ocr许可证号模糊\n\t\t\t//证号模糊无法识别\n\t\t\tevent.put(\"question_type\",114)\n\t\t}else{\n\t\t\t//是否模糊字段为空，继续进行\n\t\t\tfunc3();\n\t }\n  }\n  }else{ //未上传ocr信息\n\t//do nothing\n    }\n  }\n// }\nfunction func1(){\n\tif(licno == null || license_num.toLowerCase() !== licno.toLowerCase()){ //jy号跟jy库对比不上\n\t//证号有误\n\tevent.put(\"question_type\",111)\n\t}else{\n\t\tif(licexpiry !== null && licexpiry.toString().length > 0 && licexpirydate.getTime() < curdate.getTime()){ //证过期\n\t\t//证过期\n\t\tevent.put(\"question_type\",101)\n\t\t}else if(has_license !==null && has_license.length > 0 || has_business_license !==null && has_business_license.length > 0){  //ocr数据没有上传就不会继续计算\n\t\t\tif(has_license != 1){  //没上传许可证\n\t\t\t\t//未亮证\n\t\t\t\tevent.put(\"question_type\",112)\n\t\t\t}else if(has_license == 1){\n\t\t\t\tif(issue_date !== null && issue_date.toString().length > 0 && issue_date.getTime() > issue_time.getTime()){ //2018年1月1日后颁发\n\t\t\t\t\tif(ocr_business_scope != 1){ //主体业态没网络\n\t\t\t\t\t//无网络经营资格\n\t\t\t\t\tevent.put(\"question_type\",102)\n\t\t\t\t\t}else{\n\t\t\t\t\t\tfunc2();\n\t\t\t\t\t}\n\t\t\t\t}else{\n\t\t\t\t\tfunc2();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\n\t}\n}\n\nfunction func2(){  // 方法\n\tif(has_business_license != 1){  //未上传营业执照\n\t\t// 未亮照\n\t\tevent.put(\"question_type\",113)\n\t}else if(has_business_license == 1){  \n\t  //正常\n\t  event.put(\"question_type\",100)\n\t}\n\t\n}\n\nfunction func3(){\n\tif(licno == null || ocr_license_num.toLowerCase() !== licno.toLowerCase()){ //jy号跟jy库对比不上\n\t//证号有误\n\tevent.put(\"question_type\",111)\n\t}else{\n\t\tif(licexpiry !== null && licexpiry.toString().length > 0 && licexpirydate.getTime() < curdate.getTime()){ //证过期\n\t\t//证过期\n\t\tevent.put(\"question_type\",101)\n\t\t}else{     //TODO  药监库日期没有值,(继续下面的处理) \n\t\t\tif(has_license != 1){  //没上传许可证\n\t\t\t\t//未亮证\n\t\t\t\tevent.put(\"question_type\",112)\n\t\t\t}else if(has_license == 1){\n\t\t\t\tif(issue_date !== null && issue_date.toString().length > 0 && issue_date.getTime() > issue_time.getTime()){ //2018年1月1日后颁发\n\t\t\t\t\tif(ocr_business_scope != 1){ //主体业态没网络\n\t\t\t\t\t//无网络经营资格\n\t\t\t\t\tevent.put(\"question_type\",102)\n\t\t\t\t\t}else{\n\t\t\t\t\t\tfunc2();\n\t\t\t\t\t}\n\t\t\t\t}else{\n\t\t\t\t\tfunc2();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\nvar a=[]\nfor (var key in event){\nif(event.get(key)==\"NULL\")\n a.push(key);\n}\n\nfor (var i=0;i<a.length;i++){\n   event.remove(a[i])\n}","type":"js","name":"script"},{"fields":["MULTI_USE","orgname"],"name":"removeFields"}],"metadata":[],"name":"nothing"},"datasource":"78fd687e-6acb-4da5-a9ed-31dec2dba247","properties":[],"isSample":0}