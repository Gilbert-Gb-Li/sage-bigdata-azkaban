{"id":"9b3f6c3a-0fc1-4346-8e1c-a3a66be06984","name":"食药监-美团ES宽表","sample":"","parser":{"filter":[{"field":"license_num","cases":[{"value":"[\\s\\S]+","rule":{"id":"ac88cf93-462e-42ed-a67b-a30faf702db7","column":"licno","value":"license_num","isScript":false,"name":"byKnowledge"},"name":"case"}],"default":{"id":"ac88cf93-462e-42ed-a67b-a30faf702db7","column":"licno","value":"ocr_license_num","isScript":false,"name":"byKnowledge"},"name":"match"},{"fields":{"license_num_licno":"licno","license_num_entname":"entname","license_num_regaddrdl":"regaddrdl","ocr_license_num_managerange":"managerange","license_num_managerange":"managerange","ocr_license_num_fzr":"fzr","license_num_regaddrzl":"regaddrzl","ocr_license_num_id":"id","license_num_licexpiry":"licexpiry","ocr_license_num_licno":"licno","license_num_addr":"addr","ocr_license_num_localadm":"localadm","ocr_license_num_addr":"addr","ocr_license_credlevel":"credlevel","license_num_localadm":"localadm","license_num_credlevel":"credlevel","ocr_license_num_entname":"entname","ocr_license_num_regaddrzl":"regaddrzl","license_num_shxydm":"shxydm","ocr_license_num_regaddrdl":"regaddrdl","license_num_fzr":"fzr","ocr_license_num_shxydm":"shxydm","ocr_license_num_licexpiry":"licexpiry"},"name":"mapping"},{"script":"var license_num = event.get(\"license_num\");\r\nvar licno = event.get(\"licno\");\r\nvar license_num_localadm = event.get(\"license_num_localadm\");\r\nvar localadm = event.get(\"localadm\");\r\nvar org_code = event.get(\"org_code\");\r\n\r\n//license_num == licno &&\r\nif( localadm !== null && localadm.toString().length > 0){\r\nif(license_num_localadm != null && license_num_localadm.toString().length > 0){\r\n    event.put(\"org_code\",license_num_localadm)\r\n}else{\r\n    event.put(\"org_code\",localadm)\r\n}\r\n}","type":"js","name":"script"},{"id":"05741826-f8b0-4809-bfe5-3ec78eed8ce1","column":"orgcode","value":"org_code","isScript":false,"name":"byKnowledge"},{"fields":["localadm_orgcode","org_code_id","localadm_id","c@collector","c@path","id","pid","grade","license_num_id","template_version"],"name":"removeFields"},{"fields":{"org_code_fzr":"fzr","org_code_regaddrdl":"regaddrdl","org_code_orgcode":"orgcode","org_code_addr":"addr","org_code_licno":"licno","org_code_localadm":"localadm","org_code_licexpiry":"licexpiry","org_code_credlevel":"credlevel","orgname":"org_name","org_code_managerange":"managerange","org_code_regaddrzl":"regaddrzl","org_code_entname":"entname","org_code_shxydm":"shxydm"},"name":"mapping"},{"script":"var license_num = event.get(\"license_num\");  //资质信息许可证号\r\nvar licno = event.get(\"licno\"); //药监库许可证号\r\nvar licexpiry = event.get(\"licexpiry\");  //许可证过期时间\r\nvar ocr_issue_date = event.get(\"ocr_issue_date\"); //许可证颁发时间ocr识别\r\nvar has_license = event.get(\"has_license\");  //是否上传许可证\r\nvar is_license_vague = event.get(\"is_license_vague\");  //许可证号是否模糊\r\nvar ocr_business_scope = event.get(\"ocr_business_scope\");  //主营业态是否有网络\r\nvar has_business_license = event.get(\"has_business_license\");  //是否上传营业执照\r\nvar ocr_license_num = event.get(\"ocr_license_num\");  //图片识别许可证号\r\nvar org_code = event.get(\"org_code\");   //替换过的org_code \r\nvar key_word_hair_num = event.get(\"key_word_hair_num\");  //关键词头发评论数量\r\nvar key_word_fly_num = event.get(\"key_word_fly_num\");  //关键词苍蝇评论数量\r\nvar key_word_nfresh_num = event.get(\"key_word_nfresh_num\");  //关键词不心想评论数量\r\nvar bad_comment_total_num = event.get(\"bad_comment_total_num\");  //差评总数\r\nvar comment_total_num = event.get(\"comment_total_num\");  //评论总数\r\nvar expire_time = event.get(\"expire_time\");  //资质信息过期时间\r\nvar has_ocr_message = event.get(\"has_ocr_message\");  //是否上传ocr信息\r\nvar shop_cert_photo1 = event.get(\"shop_cert_photo1\");  //资质信息picture1\r\nvar shop_cert_photo2 = event.get(\"shop_cert_photo2\");  //资质信息picture2\r\nvar str = \"2018-01-01\";\r\nvar timestamp = new Date().getTime().toString();\r\nvar curdate = new Date();\r\nif(licexpiry !== null && licexpiry.toString().length > 0){\r\nvar licexpirydate = new Date(licexpiry);\r\n}\r\nif(ocr_issue_date !== null && ocr_issue_date.length > 0){\r\nvar issue_date = new Date(ocr_issue_date)\r\n}\r\nvar issue_time = new Date(str)\r\n\r\n//创建一证多用所需license_num字段\r\nif(ocr_license_num !== null){\r\n    event.put(\"tmp_license_num\",ocr_license_num)\r\n}\r\nif(license_num !== null && ocr_license_num == null){\r\nevent.put(\"tmp_license_num\",license_num)\r\n}\r\n\r\n//101,证过期;102,无网络经营资格;111,证号有误;112,未亮证;113,未亮照;114,JY模糊;115,证件模糊;100,正常\r\n\r\nif(expire_time == \"我平台已经对入网餐饮服务提供者的\"){\r\n\tevent.put(\"expire_time\",null)\r\n}\r\nif(has_ocr_message == null){\r\n\tevent.put(\"has_ocr_message\",0)\r\n}\r\nif(org_code){\r\nvar org_code_2 = org_code.substr(0,2);\r\nvar org_code_4 = org_code.substr(0,4);\r\nvar org_code_6 = org_code.substr(0,6);\r\nevent.put(\"org_code_2\",org_code_2)\r\nevent.put(\"org_code_4\",org_code_4)\r\nevent.put(\"org_code_6\",org_code_6)\r\n}\r\nif(key_word_hair_num == null){\r\n\tkey_word_hair_num = 0;\r\n\tevent.put(\"key_word_hair_num\",0);\r\n}\r\nif(key_word_fly_num == null){\r\n\tkey_word_fly_num = 0;\r\n\tevent.put(\"key_word_fly_num\",0);\r\n}\r\nif(key_word_nfresh_num == null){\r\n\tkey_word_nfresh_num = 0;\r\n\tevent.put(\"key_word_nfresh_num\",0);\r\n}\r\nvar key_word_total = Number(key_word_hair_num) + Number(key_word_fly_num) + Number(key_word_nfresh_num);\r\nevent.put(\"key_word_total\",key_word_total);\r\n\r\nif(comment_total_num != 0 && comment_total_num !== null ){\r\nvar bad_comment_rate = Number(bad_comment_total_num) / Number(comment_total_num);\r\n//event.put(\"bad_comment_rate\",Math.ceil(bad_comment_rate*100)/100);\r\nevent.put(\"bad_comment_rate\",bad_comment_rate);\r\n}else{\r\nevent.put(\"bad_comment_rate\",0);\r\n}\r\n\r\nif(has_license !==null && has_license.length > 0 || has_business_license !==null && has_business_license.length > 0){   //判断ocr信息是否上报\r\n\tevent.put(\"has_ocr_message\",1)\r\n}else{\r\n\tevent.put(\"has_ocr_message\",0)\r\n}\r\n// if(shop_cert_photo1 == null && shop_cert_photo2 == null){\r\n//     //未亮证\r\n// \tevent.put(\"question_type\",112)\r\n// }else{\r\nif(license_num !== null){ //公示信息有jy号\r\n //------ func1\r\n\tfunc1();\r\n //------\r\n}else{ //公示信息无jy号\r\n\tif(has_license !==null && has_license.length > 0 || has_business_license !==null && has_business_license.length > 0){\r\n\tif(has_license != 1){ //未上传许可证\r\n\t\t//未亮证\r\n\t\tevent.put(\"question_type\",112)\r\n\t}else if(has_license == 1){\r\n\t\tif(is_license_vague == 1){ //ocr许可证号模糊\r\n\t\t\t//证号模糊无法识别\r\n\t\t\tevent.put(\"question_type\",114)\r\n\t\t}else{\r\n\t\t\t//是否模糊字段为空，继续进行\r\n\t\t\tfunc3();\r\n\t }\r\n  }\r\n  }else{ //未上传ocr信息\r\n\t//do nothing\r\n    }\r\n  }\r\n// }\r\nfunction func1(){\r\n\tif(licno == null || license_num.toLowerCase() !== licno.toLowerCase()){ //jy号跟jy库对比不上\r\n\t//证号有误\r\n\tevent.put(\"question_type\",111)\r\n\t}else{\r\n\t\tif(licexpiry !== null && licexpiry.toString().length > 0 && licexpirydate.getTime() < curdate.getTime()){ //证过期\r\n\t\t//证过期\r\n\t\tevent.put(\"question_type\",101)\r\n\t\t}else if(has_license !==null && has_license.length > 0 || has_business_license !==null && has_business_license.length > 0){  //ocr数据没有上传就不会继续计算\r\n\t\t\tif(has_license != 1){  //没上传许可证\r\n\t\t\t\t//未亮证\r\n\t\t\t\tevent.put(\"question_type\",112)\r\n\t\t\t}else if(has_license == 1){\r\n\t\t\t\tif(issue_date !== null && issue_date.toString().length > 0 && issue_date.getTime() > issue_time.getTime()){ //2018年1月1日后颁发\r\n\t\t\t\t\tif(ocr_business_scope != 1){ //主体业态没网络\r\n\t\t\t\t\t//无网络经营资格\r\n\t\t\t\t\tevent.put(\"question_type\",102)\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tfunc2();\r\n\t\t\t\t\t}\r\n\t\t\t\t}else{\r\n\t\t\t\t\tfunc2();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\r\n\t}\r\n}\r\n\r\nfunction func2(){  // 方法\r\n\tif(has_business_license != 1){  //未上传营业执照\r\n\t\t// 未亮照\r\n\t\tevent.put(\"question_type\",113)\r\n\t}else if(has_business_license == 1){  \r\n\t  //正常\r\n\t  event.put(\"question_type\",100)\r\n\t}\r\n\t\r\n}\r\n\r\nfunction func3(){\r\n\tif(licno == null || ocr_license_num.toLowerCase() !== licno.toLowerCase()){ //jy号跟jy库对比不上\r\n\t//证号有误\r\n\tevent.put(\"question_type\",111)\r\n\t}else{\r\n\t\tif(licexpiry !== null && licexpiry.toString().length > 0 && licexpirydate.getTime() < curdate.getTime()){ //证过期\r\n\t\t//证过期\r\n\t\tevent.put(\"question_type\",101)\r\n\t\t}else{     //TODO  药监库日期没有值,(继续下面的处理) \r\n\t\t\tif(has_license != 1){  //没上传许可证\r\n\t\t\t\t//未亮证\r\n\t\t\t\tevent.put(\"question_type\",112)\r\n\t\t\t}else if(has_license == 1){\r\n\t\t\t\tif(issue_date !== null && issue_date.toString().length > 0 && issue_date.getTime() > issue_time.getTime()){ //2018年1月1日后颁发\r\n\t\t\t\t\tif(ocr_business_scope != 1){ //主体业态没网络\r\n\t\t\t\t\t//无网络经营资格\r\n\t\t\t\t\tevent.put(\"question_type\",102)\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tfunc2();\r\n\t\t\t\t\t}\r\n\t\t\t\t}else{\r\n\t\t\t\t\tfunc2();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nvar a=[]\r\nfor (var key in event){\r\nif(event.get(key)==\"NULL\")\r\n a.push(key);\r\n}\r\n\r\nfor (var i=0;i<a.length;i++){\r\n   event.remove(a[i])\r\n}","type":"js","name":"script"},{"fields":["MULTI_USE","orgname"],"name":"removeFields"}],"metadata":[],"name":"nothing"},"datasource":"2a3fb52b-c69a-4e09-b887-f5038cfff847","properties":[],"isSample":0}