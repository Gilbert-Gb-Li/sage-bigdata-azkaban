{"id":"72e82d71-cda5-488c-922b-c814ced4e12e","name":"食药监-ES宽表_plus","sample":"","parser":{"filter":[{"field":"license_num","cases":[{"value":"[\\s\\S]+","rule":{"id":"ac88cf93-462e-42ed-a67b-a30faf702db7","column":"licno","value":"license_num","isScript":false,"name":"byKnowledge"},"name":"case"}],"default":{"id":"ac88cf93-462e-42ed-a67b-a30faf702db7","column":"licno","value":"ocr_license_num","isScript":false,"name":"byKnowledge"},"name":"match"},{"fields":{"license_num_licno":"licno","license_num_entname":"entname","license_num_regaddrdl":"regaddrdl","ocr_license_num_managerange":"managerange","license_num_managerange":"managerange","ocr_license_num_fzr":"fzr","license_num_regaddrzl":"regaddrzl","ocr_license_num_id":"id","license_num_licexpiry":"licexpiry","ocr_license_num_licno":"licno","license_num_addr":"addr","ocr_license_num_localadm":"localadm","ocr_license_num_addr":"addr","ocr_license_credlevel":"credlevel","license_num_localadm":"localadm","license_num_credlevel":"credlevel","ocr_license_num_entname":"entname","ocr_license_num_regaddrzl":"regaddrzl","license_num_shxydm":"shxydm","ocr_license_num_regaddrdl":"regaddrdl","license_num_fzr":"fzr","ocr_license_num_shxydm":"shxydm","ocr_license_num_licexpiry":"licexpiry"},"name":"mapping"},{"script":"var license_num = event.get(\"license_num\");\r\nvar licno = event.get(\"licno\");\r\nvar license_num_localadm = event.get(\"license_num_localadm\");\r\nvar localadm = event.get(\"localadm\");\r\nvar org_code = event.get(\"org_code\");\r\n\r\n//license_num == licno &&\r\nif( localadm !== null && localadm.toString().length > 0){\r\nif(license_num_localadm != null && license_num_localadm.toString().length > 0){\r\n    event.put(\"org_code\",license_num_localadm)\r\n}else{\r\n    event.put(\"org_code\",localadm)\r\n}\r\n}","type":"js","name":"script"},{"id":"05741826-f8b0-4809-bfe5-3ec78eed8ce1","column":"orgcode","value":"org_code","isScript":false,"name":"byKnowledge"},{"fields":["localadm_orgcode","org_code_id","localadm_id","c@collector","c@path","id","pid","grade","license_num_id","template_version"],"name":"removeFields"},{"fields":{"org_code_fzr":"fzr","org_code_regaddrdl":"regaddrdl","org_code_orgcode":"orgcode","org_code_addr":"addr","org_code_licno":"licno","org_code_localadm":"localadm","org_code_licexpiry":"licexpiry","org_code_credlevel":"credlevel","orgname":"org_name","org_code_managerange":"managerange","org_code_regaddrzl":"regaddrzl","org_code_entname":"entname","org_code_shxydm":"shxydm"},"name":"mapping"},{"script":"var license_num = event.get(\"license_num\");  //资质信息许可证号\r\nvar licno = event.get(\"licno\"); //药监库许可证号\r\nvar licexpiry = event.get(\"licexpiry\");  //许可证过期时间\r\nvar ocr_issue_date = event.get(\"ocr_issue_date\"); //许可证颁发时间ocr识别\r\nvar has_license = event.get(\"has_license\");  //是否上传许可证\r\nvar is_license_vague = event.get(\"is_license_vague\");  //许可证号是否模糊\r\nvar ocr_business_scope = event.get(\"ocr_business_scope\");  //主营业态是否有网络\r\nvar has_business_license = event.get(\"has_business_license\");  //是否上传营业执照\r\nvar ocr_license_num = event.get(\"ocr_license_num\");  //图片识别许可证号\r\nvar org_code = event.get(\"org_code\");   //替换过的org_code \r\nvar key_word_hair_num = event.get(\"key_word_hair_num\");  //关键词头发评论数量\r\nvar key_word_fly_num = event.get(\"key_word_fly_num\");  //关键词苍蝇评论数量\r\nvar key_word_nfresh_num = event.get(\"key_word_nfresh_num\");  //关键词不心想评论数量\r\nvar bad_comment_total_num = event.get(\"bad_comment_total_num\");  //差评总数\r\nvar comment_total_num = event.get(\"comment_total_num\");  //评论总数\r\nvar expire_time = event.get(\"expire_time\");  //资质信息过期时间\r\nvar has_ocr_message = event.get(\"has_ocr_message\");  //是否上传ocr信息\r\nvar shop_cert_photo1 = event.get(\"shop_cert_photo1\");  //资质信息picture1\r\nvar shop_cert_photo2 = event.get(\"shop_cert_photo2\");  //资质信息picture2\r\nvar str = \"2018-01-01\";\r\nvar timestamp = new Date().getTime().toString();\r\nvar curdate = new Date();\r\nif(licexpiry !== null && licexpiry.toString().length > 0){\r\nvar licexpirydate = new Date(licexpiry);\r\n}\r\nif(ocr_issue_date !== null && ocr_issue_date.length > 0){\r\nvar issue_date = new Date(ocr_issue_date)\r\n}\r\nvar issue_time = new Date(str)\r\n\r\n//创建一证多用所需license_num字段\r\nif(ocr_license_num !== null){\r\n    event.put(\"tmp_license_num\",ocr_license_num)\r\n}\r\nif(license_num !== null && ocr_license_num == null){\r\nevent.put(\"tmp_license_num\",license_num)\r\n}\r\n\r\n//101,证过期;102,无网络经营资格;111,证号有误;112,未亮证;113,未亮照;114,JY模糊;115,证件模糊;100,正常\r\n\r\nif(expire_time == \"我平台已经对入网餐饮服务提供者的\"){\r\n\tevent.put(\"expire_time\",null)\r\n}\r\nif(has_ocr_message == null){\r\n\tevent.put(\"has_ocr_message\",0)\r\n}\r\nif(org_code){\r\nvar org_code_2 = org_code.substr(0,2);\r\nvar org_code_4 = org_code.substr(0,4);\r\nvar org_code_6 = org_code.substr(0,6);\r\nevent.put(\"org_code_2\",org_code_2)\r\nevent.put(\"org_code_4\",org_code_4)\r\nevent.put(\"org_code_6\",org_code_6)\r\n}\r\nif(key_word_hair_num == null){\r\n\tkey_word_hair_num = 0;\r\n\tevent.put(\"key_word_hair_num\",0);\r\n}\r\nif(key_word_fly_num == null){\r\n\tkey_word_fly_num = 0;\r\n\tevent.put(\"key_word_fly_num\",0);\r\n}\r\nif(key_word_nfresh_num == null){\r\n\tkey_word_nfresh_num = 0;\r\n\tevent.put(\"key_word_nfresh_num\",0);\r\n}\r\nvar key_word_total = Number(key_word_hair_num) + Number(key_word_fly_num) + Number(key_word_nfresh_num);\r\nevent.put(\"key_word_total\",key_word_total);\r\n\r\nif(comment_total_num != 0 && comment_total_num !== null ){\r\nvar bad_comment_rate = Number(bad_comment_total_num) / Number(comment_total_num);\r\n//event.put(\"bad_comment_rate\",Math.ceil(bad_comment_rate*100)/100);\r\nevent.put(\"bad_comment_rate\",bad_comment_rate);\r\n}else{\r\nevent.put(\"bad_comment_rate\",0);\r\n}\r\n\r\nif(has_license !==null && has_license.length > 0 || has_business_license !==null && has_business_license.length > 0){   //判断ocr信息是否上报\r\n\tevent.put(\"has_ocr_message\",1)\r\n}else{\r\n\tevent.put(\"has_ocr_message\",0)\r\n}\r\n// if(shop_cert_photo1 == null && shop_cert_photo2 == null){\r\n//     //未亮证\r\n// \tevent.put(\"question_type\",112)\r\n// }else{\r\nif(license_num !== null){ //公示信息有jy号\r\n //------ func1\r\n\tfunc1();\r\n //------\r\n}else{ //公示信息无jy号\r\n\tif(has_license !==null && has_license.length > 0 || has_business_license !==null && has_business_license.length > 0){\r\n\tif(has_license != 1){ //未上传许可证\r\n\t\t//未亮证\r\n\t\tevent.put(\"question_type\",112)\r\n\t}else if(has_license == 1){\r\n\t\tif(is_license_vague == 1){ //ocr许可证号模糊\r\n\t\t\t//证号模糊无法识别\r\n\t\t\tevent.put(\"question_type\",114)\r\n\t\t}else{\r\n\t\t\t//是否模糊字段为空，继续进行\r\n\t\t\tfunc3();\r\n\t }\r\n  }\r\n  }else{ //未上传ocr信息\r\n\t//do nothing\r\n    }\r\n  }\r\n// }\r\nfunction func1(){\r\n\tif(licno == null || license_num.toLowerCase() !== licno.toLowerCase()){ //jy号跟jy库对比不上\r\n\t//证号有误\r\n\tevent.put(\"question_type\",111)\r\n\t}else{\r\n\t\tif(licexpiry !== null && licexpiry.toString().length > 0 && licexpirydate.getTime() < curdate.getTime()){ //证过期\r\n\t\t//证过期\r\n\t\tevent.put(\"question_type\",101)\r\n\t\t}else if(has_license !==null && has_license.length > 0 || has_business_license !==null && has_business_license.length > 0){  //ocr数据没有上传就不会继续计算\r\n\t\t\tif(has_license != 1){  //没上传许可证\r\n\t\t\t\t//未亮证\r\n\t\t\t\tevent.put(\"question_type\",112)\r\n\t\t\t}else if(has_license == 1){\r\n\t\t\t\tif(issue_date !== null && issue_date.toString().length > 0 && issue_date.getTime() > issue_time.getTime()){ //2018年1月1日后颁发\r\n\t\t\t\t\tif(ocr_business_scope != 1){ //主体业态没网络\r\n\t\t\t\t\t//无网络经营资格\r\n\t\t\t\t\tevent.put(\"question_type\",102)\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tfunc2();\r\n\t\t\t\t\t}\r\n\t\t\t\t}else{\r\n\t\t\t\t\tfunc2();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\r\n\t}\r\n}\r\n\r\nfunction func2(){  // 方法\r\n\tif(has_business_license != 1){  //未上传营业执照\r\n\t\t// 未亮照\r\n\t\tevent.put(\"question_type\",113)\r\n\t}else if(has_business_license == 1){  \r\n\t  //正常\r\n\t  event.put(\"question_type\",100)\r\n\t}\r\n\t\r\n}\r\n\r\nfunction func3(){\r\n\tif(licno == null || ocr_license_num.toLowerCase() !== licno.toLowerCase()){ //jy号跟jy库对比不上\r\n\t//证号有误\r\n\tevent.put(\"question_type\",111)\r\n\t}else{\r\n\t\tif(licexpiry !== null && licexpiry.toString().length > 0 && licexpirydate.getTime() < curdate.getTime()){ //证过期\r\n\t\t//证过期\r\n\t\tevent.put(\"question_type\",101)\r\n\t\t}else{     //TODO  药监库日期没有值,(继续下面的处理) \r\n\t\t\tif(has_license != 1){  //没上传许可证\r\n\t\t\t\t//未亮证\r\n\t\t\t\tevent.put(\"question_type\",112)\r\n\t\t\t}else if(has_license == 1){\r\n\t\t\t\tif(issue_date !== null && issue_date.toString().length > 0 && issue_date.getTime() > issue_time.getTime()){ //2018年1月1日后颁发\r\n\t\t\t\t\tif(ocr_business_scope != 1){ //主体业态没网络\r\n\t\t\t\t\t//无网络经营资格\r\n\t\t\t\t\tevent.put(\"question_type\",102)\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tfunc2();\r\n\t\t\t\t\t}\r\n\t\t\t\t}else{\r\n\t\t\t\t\tfunc2();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nvar a=[]\r\nfor (var key in event){\r\nif(event.get(key)==\"NULL\")\r\n a.push(key);\r\n}\r\n\r\nfor (var i=0;i<a.length;i++){\r\n   event.remove(a[i])\r\n}","type":"js","name":"script"},{"fields":{"MULTI_USE":"multi_use"},"name":"mapping"},{"fields":["MULTI_USE","orgname"],"name":"removeFields"}],"metadata":[["managerange","string",""],["latitude","string",""],["waimai_licese","string",""],["org_code_4","string",""],["fzr","string",""],["orgcode","string",""],["licno","string",""],["shxydm","string",""],["credlevel","string",""],["longitude","string",""],["regaddrdl","string",""],["open_time","string",""],["org_code","string",""],["org_code_6","string",""],["licexpiry","string","yyyy-MM-dd"],["addr","string",""],["org_name","string",""],["province","string",""],["address","string",""],["localadm","string",""],["entname","string",""],["org_code_2","string",""],["shop_logo","string",""],["regaddrzl","string",""],["phone","string",""],["waimai_type","string",""],["shop_name","string",""],["has_ocr_message","string",""],["last_check_grade","string",""],["local_logo","string",""],["a@analyze_time","string",""],["multi_use","integer",""],["check_date","string",""],["shop_cert_photo1","string",""],["shop_cert_photo2","string",""],["tmp_license_num","string",""],["question_type","string",""],["shop_id","string",""],["key_word_total","integer",""],["key_word_fly_num","integer",""],["place_grade","string",""],["license_num","string",""],["key_word_nfresh_num","integer",""],["geo_hash","string",""],["key_word_hair_num","integer",""],["bad_comment_rate","double",""],["manage_grade","string",""]],"name":"nothing"},"datasource":"2a3fb52b-c69a-4e09-b887-f5038cfff847","properties":[{"id":"e14670fa-56b4-4b29-9a1c-fb87c44d32fa","type":"string","key":"managerange","sample":"None"},{"id":"0725ce36-c619-44a6-af9b-9f701c029f8e","type":"string","key":"latitude","sample":"None"},{"id":"f3d53606-ce74-4de4-9147-6976b2f90c80","type":"string","key":"waimai_licese","sample":"None"},{"id":"347bc5ae-2229-4fdc-af0d-2b17d9050d05","type":"string","key":"org_code_4","sample":"None"},{"id":"94647512-a85e-423e-bcea-e6007ca1ca39","type":"string","key":"fzr","sample":"None"},{"id":"1ebacc9e-b0fa-42f3-9c24-75e1c2e57ca7","type":"string","key":"orgcode","sample":"None"},{"id":"ed36963c-180c-4704-b1ff-e87937f48f3d","type":"string","key":"licno","sample":"None"},{"id":"21d88341-bc79-476e-b5ba-2044c8a8c82a","type":"string","key":"shxydm","sample":"None"},{"id":"b5c0dad2-7b96-461f-befe-da0cc8a8cb01","type":"string","key":"credlevel","sample":"None"},{"id":"3f3521da-f5a6-4e7e-a356-e53782cae149","type":"string","key":"longitude","sample":"None"},{"id":"2a03d453-0652-43f9-804d-2635cfda88ce","type":"string","key":"regaddrdl","sample":"None"},{"id":"8630656d-0371-4911-94b4-82b1c027d5a0","type":"string","key":"open_time","sample":"None"},{"id":"bbaab7b7-d7f0-428f-a69a-065da191333e","type":"string","key":"org_code","sample":"None"},{"id":"f2c61fa1-f9c2-41f8-bc98-cedd7c686b7e","type":"string","key":"org_code_6","sample":"None"},{"id":"e1038f33-92db-457f-ac3e-e3bfbfbc9a24","type":"string","key":"licexpiry","format":"yyyy-MM-dd","sample":"None"},{"id":"f796e93b-fe77-444e-b5aa-819ac3fa4fe6","type":"string","key":"addr","sample":"None"},{"id":"61c050d1-7075-4061-8d13-07a0f143c026","type":"string","key":"org_name","sample":"None"},{"id":"13d54105-6756-4b32-a694-e54fa693fa04","type":"string","key":"province","sample":"None"},{"id":"367cd07d-7c4c-488f-9c3e-8d1aeabf8d65","type":"string","key":"address","sample":"None"},{"id":"ae26ce8a-2bb1-44c3-a1ff-715af1d8dc27","type":"string","key":"localadm","sample":"None"},{"id":"ad9c322c-7310-4592-b6bc-8d1197691ee8","type":"string","key":"entname","sample":"None"},{"id":"2d31242e-a5e1-4db2-b808-7fd124973979","type":"string","key":"org_code_2","sample":"None"},{"id":"c5a0cc59-d558-4e5a-b2e3-ce7876a65a98","type":"string","key":"shop_logo","sample":"None"},{"id":"a4fe9583-0455-4852-82bf-ee06c2254b7d","type":"string","key":"regaddrzl","sample":"None"},{"id":"25884b2f-7263-4562-ac85-130067397d53","type":"string","key":"phone","sample":"None"},{"id":"2cbea5b6-c0fc-4075-997a-42883f3b5667","type":"string","key":"waimai_type","sample":"1"},{"id":"36a1b699-1f99-4dcf-9c2d-3d235692d3cb","type":"string","key":"shop_name","sample":"商家名称"},{"id":"30064d3f-7d40-43a8-a022-2e2ab17709ec","type":"string","key":"has_ocr_message","sample":"0"},{"id":"0f957f26-c620-42d3-b6da-893c8078bce2","type":"string","key":"last_check_grade","sample":"5"},{"id":"1bbaca15-65c6-41a8-ae48-f43ba3b1e408","type":"string","key":"local_logo","sample":"4"},{"id":"25640241-57b2-4278-98c8-be799e0d27c2","type":"string","key":"a@analyze_time","sample":"None"},{"id":"2651fefb-426d-40c2-afa1-9393a9cfccec","type":"integer","key":"multi_use","sample":"None"},{"id":"bb3fb2ff-f65d-4863-ab22-16bc2f2ef021","type":"string","key":"check_date","sample":"62010231"},{"id":"ba723e52-457d-468a-b4a6-1a31105a2b00","type":"string","key":"shop_cert_photo1","sample":"http://p1.meituan.net/waimaipoi/4e579a8a639ac66ad1c89ce8e43cad681250805555555.jpg"},{"id":"23b0cd30-286d-40e0-ad7f-3432a1cc409c","type":"string","key":"shop_cert_photo2","sample":"fdasfasdfdas.jpg"},{"id":"98945a65-b292-4c84-b7ce-210c466fdd57","type":"string","key":"tmp_license_num","sample":"88882265"},{"id":"18ef5ac7-9c3f-4460-bec0-657c9e27845e","type":"string","key":"question_type","sample":"111"},{"id":"bd7d3e90-aaf1-48e0-a920-efa40afcb16c","type":"string","key":"shop_id","sample":"1_test230"},{"id":"72203594-71f2-4ac7-a096-4eb6dcef26e6","type":"integer","key":"key_word_total","sample":"0.0"},{"id":"e677a114-abcc-4259-aab2-6a05f731814d","type":"integer","key":"key_word_fly_num","sample":"0"},{"id":"78d103e7-c197-4ee0-9e81-b707d6288733","type":"string","key":"place_grade","sample":"6"},{"id":"8ea47a42-0885-4547-8e0b-b7339d6fb949","type":"string","key":"license_num","sample":"88882265"},{"id":"014d103e-2a80-4ea6-b02c-477213b0e8ba","type":"integer","key":"key_word_nfresh_num","sample":"0"},{"id":"767da499-83bf-4ec7-8542-fc2e5541a9ee","type":"string","key":"geo_hash","sample":"3"},{"id":"dabd2bb5-dd5d-4c42-992a-2e4a1e2b02b4","type":"integer","key":"key_word_hair_num","sample":"0"},{"id":"ab3461a9-2db5-46da-ac2a-81f3688e73df","type":"double","key":"bad_comment_rate","sample":"0"},{"id":"056069c1-8d9b-4031-8253-c9000efd7c58","type":"string","key":"manage_grade","sample":"7"}],"isSample":0}